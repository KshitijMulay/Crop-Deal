package com.farmer.service;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import com.farmer.feign.FarmerInterface;
import com.farmer.feign.NotificationInterface;
import com.farmer.model.BankDetails;
import com.farmer.model.CropDto;
import com.farmer.model.Farmer;
import com.farmer.model.NotificationDto;
import com.farmer.repo.BankDetailsRepo;
import com.farmer.repo.FarmerRepo;

@Service
public class FarmerService {

	@Autowired
	FarmerRepo farmerRepo;

	@Autowired
	BankDetailsRepo bankRepo;

	@Autowired
	FarmerInterface farmerInterface;

	@Autowired
	NotificationInterface notificationInterface;

	public ResponseEntity<List<Farmer>> getAllFarmers() {
		try {
			return new ResponseEntity<>(farmerRepo.findAll(), HttpStatus.OK);
		} catch (Exception e) {
			e.printStackTrace();
		}
		return new ResponseEntity<>(new ArrayList<>(), HttpStatus.BAD_REQUEST);
	}

	public String deleteFarmerById(int id) {
		farmerRepo.deleteById(id);
		return "Farmer deleted succesfully";
	}

	public ResponseEntity<String> registerFarmer(Farmer farmer) {
		farmerRepo.save(farmer);
		return new ResponseEntity<>(farmer.getFirst_name() + " you have registered successfully as Farmer", HttpStatus.CREATED);
	}

	public ResponseEntity<Optional<Farmer>> getFarmerProfileDetailsById(int id) {
		try {
			Optional<Farmer> farmer = farmerRepo.findById(id);
			return new ResponseEntity<>(farmer, HttpStatus.OK);
		} catch (Exception e) {
			e.printStackTrace();
		}
		return new ResponseEntity<>(null, HttpStatus.BAD_REQUEST);
	}

	public ResponseEntity<String> editFarmerProfile(int id, Farmer farmer) {
		if (farmerRepo.existsById(id)) {
			farmer.setFarmer_id(id);
			farmerRepo.save(farmer);
			return new ResponseEntity<>("farmer profile updated successfully", HttpStatus.OK);
		}
		return new ResponseEntity<>("farmer not found", HttpStatus.CREATED);
	}

	public ResponseEntity<String> addBankDetails(int farmerId, BankDetails bankDetails) {
		Optional<Farmer> optionalFarmer = farmerRepo.findById(farmerId);

		if (optionalFarmer.isPresent()) {
			Farmer farmer = optionalFarmer.get();

			BankDetails savedBank = bankRepo.save(bankDetails);

			farmer.setBankDetails(savedBank);
			farmerRepo.save(farmer);

			return new ResponseEntity<>("Bank details added successfully", HttpStatus.OK);
		} else {
			return new ResponseEntity<>("Farmer not found", HttpStatus.NOT_FOUND);
		}
	}

	public ResponseEntity<String> updateBankDetails(int farmerId, BankDetails newDetails) {
		Optional<Farmer> optionalFarmer = farmerRepo.findById(farmerId);

		if (optionalFarmer.isPresent()) {
			Farmer farmer = optionalFarmer.get();

			BankDetails existing = farmer.getBankDetails();

			if (existing == null) {
				return new ResponseEntity<>("No existing bank details found.please add bank details",
						HttpStatus.NOT_FOUND);
			}

			existing.setBankName(newDetails.getBankName());
			existing.setAccountNumber(newDetails.getAccountNumber());
			existing.setIfscCode(newDetails.getIfscCode());
			existing.setUpiId(newDetails.getUpiId());
			existing.setUpiNumber(newDetails.getUpiNumber());

			bankRepo.save(existing);

			return new ResponseEntity<>("Bank details updated successfully", HttpStatus.OK);
		}
		return new ResponseEntity<>("Farmer not found", HttpStatus.NOT_FOUND);
	}

	public ResponseEntity<String> publishCrop(int farmer_id, CropDto cropDto) {
		cropDto.setFarmerId(farmer_id);

		ResponseEntity<String> result = farmerInterface.publishCrop(cropDto);

		if (result.getStatusCode().is2xxSuccessful()) {
			NotificationDto payload = new NotificationDto();
			payload.setSubject("!!! New Crop Published!");
			payload.setBody("A new crop has been published by Farmer ID: " + farmer_id
					+ "\nCrop Name: "+ cropDto.getCropName()
					+ "\nType: " + cropDto.getCropType()
					+ "\nQuantity: " + cropDto.getQuantityAvailable() + " KG"
					+ "\nPrice: â‚¹" + cropDto.getPricePerKg() + " per KG");

			notificationInterface.notifyDealers(payload);
			notificationInterface.publishedCrop(cropDto);
		}

		return result;
	}

	// 9
	public ResponseEntity<String> editCropByFarmer(int farmerId, int cropId, CropDto cropDto) {

		return farmerInterface.editCrop(cropId, cropDto);
	}

	// 10
	public ResponseEntity<String> deleteCropByFarmer(int farmerId, int cropId) {

		return farmerInterface.deleteCrop(cropId);
	}

	public ResponseEntity<List<CropDto>> getAllCrops() {
		return farmerInterface.getAllCrops();

	}

	public ResponseEntity<List<CropDto>> getCropsByFarmer(int farmerId) {
		List<CropDto> crops = farmerInterface.getCropsByFarmer(farmerId);

		return ResponseEntity.ok(crops);
	}

	public ResponseEntity<String> getCropStatusByFarmer(int crop_id) {
		return farmerInterface.getCropStatus(crop_id);

	}

}
